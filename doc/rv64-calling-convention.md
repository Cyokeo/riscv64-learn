# RISC-V Calling Convention

> 本文基于 RISC-V ELF psABI 规范（LP64，64 位），给出最常用、最精简的调用约定总结，方便快速查阅与面试速记。

---

## 1 总则
| 项目 | 说明 |
|---|---|
| **参数寄存器** | 整数 `a0`–`a7`（x10–x17） |
| **浮点参数寄存器** | `fa0`–`fa7`（f10–f17） |
| **返回值** | 整数 `a0`/`a1`，浮点 `fa0`/`fa1` |
| **调用者保存** | `ra`, `t0`–`t6`, `a0`–`a7`, `ft0`–`ft11` |
| **被调用者保存** | `s0`–`s11`, `fs0`–`fs11`, `sp` |
| **栈对齐** | 16 字节（SP mod 16 == 0） |

---

## 2 寄存器速览
| 寄存器 | ABI 名 | 保存方 | 用途 |
|---|---|---|---|
| x0 | zero | — | 硬连线 0 |
| x1 | ra | caller | 返回地址 |
| x2 | sp | callee | 栈指针 |
| x8 | s0/fp | callee | 保存寄存器 / 帧指针 |
| x10–x17 | a0–a7 | caller | 参数 / 返回值 |
| x18–x27 | s2–s11 | callee | 保存寄存器 |
| x28–x31 | t3–t6 | caller | 临时 |
| f10–f17 | fa0–fa7 | caller | 浮点参数 / 返回值 |
| fs0–fs11 | — | callee | 浮点保存寄存器 |

---

## 3 参数传递规则
| 参数序号 | 整数寄存器 | 浮点寄存器 |
|---|---|---|
| 1 | a0 | fa0 |
| 2 | a1 | fa1 |
| … | … | … |
| 8 | a7 | fa7 |
| ≥9 | **压栈**，按 8 字节对齐 |

> 整数与浮点 **互不重叠**；结构体按字段类型拆分后填充。

---

## 4 返回值规则
| 返回数据 | 寄存器 |
|---|---|
| ≤2 个整型/指针 | a0, a1 |
| ≤2 个浮点 | fa0, fa1 |
| 更大结构体 | **调用者**预先在栈上分配空间，地址作为隐藏第 1 参数（a0）传入 |

---

## 5 栈帧布局（高 → 低）
高地址
├─ caller 栈帧
├─ 返回地址 (ra)        ← callee 保存
├─ callee-saved 寄存器
├─ 局部变量
├─ 溢出参数（>8 个）
├─ 对齐填充
低地址 (sp)

- 帧指针（s0/fp）可选，调试或动态栈分配时启用。  
- 叶子函数无局部变量时可完全省栈帧。

---

## 6 可变参数（varargs）
- 固定参数仍用寄存器。  
- 额外参数**全部压栈**，8 字节对齐。  
- `va_list` 需保存 `a0–a7` 与 `fa0–fa7` 到栈供解析。

---

## 7 汇编示例
```asm
# 调用 int add(int a, int b)
li   a0, 3
li   a1, 4
call add        # ra = PC+4
mv   t0, a0     # 结果在 a0

# 被调用者
add:
    add a0, a0, a1
    ret
```

## 8 速记口诀
> “整数 a0-a7，浮点 fa0-fa7，返回值 a0/a1；
> 16 字节栈对齐，caller 保存临时，callee 保存 s 与 sp。”
